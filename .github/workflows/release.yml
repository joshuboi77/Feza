name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on semantic version tags like v1.2.3
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3)"
        required: true
        type: string
      name:
        description: "Tool name"
        required: true
        type: string
      targets:
        description: "Comma-separated targets (default: macos-arm64,macos-amd64,linux-amd64)"
        required: false
        type: string
        default: "macos-arm64,macos-amd64,linux-amd64"

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      TAG: ${{ steps.vars.outputs.TAG }}
      NAME: ${{ steps.vars.outputs.NAME }}
      TARGETS: ${{ steps.vars.outputs.TARGETS }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Feza
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Set variables
        id: vars
        run: |
          echo "TAG=${{ inputs.tag || github.ref_name }}" >> $GITHUB_OUTPUT
          echo "NAME=${{ inputs.name || 'feza' }}" >> $GITHUB_OUTPUT
          echo "TARGETS=${{ inputs.targets || 'macos-arm64,macos-amd64,linux-amd64' }}" >> $GITHUB_OUTPUT

      - name: Plan release
        run: |
          feza plan "${{ steps.vars.outputs.TAG }}" --name "${{ steps.vars.outputs.NAME }}" --targets "${{ steps.vars.outputs.TARGETS }}"
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: dist/feza_manifest.json

      - name: Upload Python script (if generated)
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: python-script
          path: create_python_binaries.sh

  build:
    needs: plan
    runs-on: ${{ matrix.os }}
    outputs:
      TAG: ${{ needs.plan.outputs.TAG }}
      NAME: ${{ needs.plan.outputs.NAME }}
      TARGETS: ${{ needs.plan.outputs.TARGETS }}
    strategy:
      matrix:
        include:
          - os: macos-14
            target: macos-arm64
          - os: macos-14
            target: macos-amd64
          - os: ubuntu-latest
            target: linux-amd64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Feza
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: manifest
          path: dist/

      - name: Download Python script (if exists)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: python-script
          path: .

      - name: Build artifacts
        run: |
          # Find create_python_binaries.sh (artifact download might put it in a subdirectory)
          SCRIPT_PATH=$(find . -name "create_python_binaries.sh" -type f 2>/dev/null | head -1)
          
          if [ -n "$SCRIPT_PATH" ] && [ -f "$SCRIPT_PATH" ]; then
            echo "Python project detected - found script at: $SCRIPT_PATH"
            echo "Running create_python_binaries.sh to create wrapper binaries..."
            chmod +x "$SCRIPT_PATH"
            "$SCRIPT_PATH"
            echo "Verifying binaries were created:"
            ls -la build/*/ || echo "No build directories found"
          else
            echo "Warning: create_python_binaries.sh not found"
            echo "TODO: Build your binary for ${{ matrix.target }}"
            echo "Binary should be placed at: build/${{ matrix.target }}/${{ needs.plan.outputs.NAME }}"
            mkdir -p build/${{ matrix.target }}
            touch build/${{ matrix.target }}/${{ needs.plan.outputs.NAME }}
          fi

      - name: Package and compute checksums
        run: |
          feza build ${{ needs.plan.outputs.TAG }} --name ${{ needs.plan.outputs.NAME }} \
            --artifacts-dir build/ \
            --dist dist/ \
            --repo ${{ github.repository }} \
            --target ${{ matrix.target }}

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.target }}
          path: dist/*.tar.gz
          if-no-files-found: error

      - name: Upload updated manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest-updated-${{ matrix.target }}
          path: dist/feza_manifest.json

  merge-manifest:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all manifests
        uses: actions/download-artifact@v4
        with:
          pattern: manifest-updated-*
          path: manifests/

      - name: Merge manifest
        run: |
          python -c "
          import json
          import glob
          import os
          import sys
          
          manifests = [json.load(open(f)) for f in glob.glob('manifests/**/feza_manifest.json', recursive=True)]
          if not manifests:
              print('::error::No manifests found to merge')
              sys.exit(1)
          
          merged = manifests[0]
          expected_targets = {a['target'] for a in merged['assets']}
          
          for m in manifests[1:]:
              for asset in m['assets']:
                  existing = next((a for a in merged['assets'] if a['target'] == asset['target']), None)
                  if existing:
                      # Preserve non-empty values (prefer complete data over empty)
                      for key in ['sha256', 'url']:
                          if asset.get(key) and (not existing.get(key) or not existing.get(key).strip()):
                              existing[key] = asset[key]
                          elif not existing.get(key):
                              existing[key] = asset.get(key, '')
                  else:
                      print('::warning::Unexpected target in manifest: ' + asset['target'])
          
          # Validate all targets have sha256 and url
          missing = []
          for asset in merged['assets']:
              if not asset.get('sha256') or not asset.get('sha256').strip():
                  missing.append(asset['target'] + ' (missing sha256)')
              if not asset.get('url') or not asset.get('url').strip():
                  missing.append(asset['target'] + ' (missing url)')
          
          if missing:
              print('::error::Missing data in merged manifest: ' + ', '.join(missing))
              sys.exit(1)
          
          os.makedirs('dist', exist_ok=True)
          json.dump(merged, open('dist/feza_manifest.json', 'w'), indent=2)
          print('Merged manifest with ' + str(len(merged['assets'])) + ' assets')
          "

      - name: Upload final manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest-final
          path: dist/feza_manifest.json

  github:
    needs: [plan, merge-manifest]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Feza
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

      - name: Authenticate GitHub CLI
        run: echo "GitHub CLI will use GH_TOKEN environment variable"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download manifest and packages
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: manifest-final
          path: dist/

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: package-*
          path: dist/
          merge-multiple: true

      - name: Create/update GitHub release
        run: |
          feza github ${{ needs.plan.outputs.TAG }} --name ${{ needs.plan.outputs.NAME }} \
            --repo ${{ github.repository }} \
            --dist dist/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  tap:
    needs: [plan, github]
    runs-on: ubuntu-latest
    if: ${{ secrets.TAP_REPO != '' && secrets.TAP_PAT != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Feza
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

      - name: Authenticate GitHub CLI
        run: echo "GitHub CLI will use GH_TOKEN environment variable"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download manifest
        uses: actions/download-artifact@v4
        with:
          name: manifest-final
          path: dist/

      - name: Push to Homebrew tap
        run: |
          FORMULA_NAME=$(echo "${{ needs.plan.outputs.NAME }}" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')
          feza tap ${{ needs.plan.outputs.TAG }} --name ${{ needs.plan.outputs.NAME }} \
            --tap ${{ secrets.TAP_REPO }} \
            --formula $FORMULA_NAME \
            --open-pr
        env:
          TAP_PAT: ${{ secrets.TAP_PAT }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

